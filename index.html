<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>DJ MASTER PRO v7 - Auto-Name & Multi-Format</title>
    <style>
        :root { --neon: #00ffcc; --dark: #050505; --gray: #1a1a1a; }
        body { background: var(--dark); color: var(--neon); font-family: 'Consolas', monospace; padding: 20px; text-align: center; }
        .master-panel { background: var(--gray); border: 2px solid var(--neon); max-width: 900px; margin: auto; padding: 30px; border-radius: 20px; box-shadow: 0 0 30px rgba(0,255,204,0.15); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; background: #000; padding: 20px; border-radius: 10px; border: 1px solid #333; text-align: left; }
        .stat-item { font-size: 0.85rem; color: #fff; }
        .stat-item span { color: var(--neon); font-weight: bold; }
        canvas { width: 100%; height: 150px; background: #000; border-radius: 10px; margin: 20px 0; border: 1px solid #444; }
        
        .format-selector { margin: 20px 0; padding: 15px; background: #222; border-radius: 10px; }
        select { background: #000; color: var(--neon); border: 1px solid var(--neon); padding: 10px; border-radius: 5px; cursor: pointer; }
        
        .btn-master { background: var(--neon); color: black; border: none; padding: 18px 40px; font-weight: bold; font-size: 1.1rem; border-radius: 50px; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .btn-master:hover { box-shadow: 0 0 25px var(--neon); transform: translateY(-2px); }
        #status-log { margin-top: 15px; font-style: italic; color: #888; }
    </style>
</head>
<body>

<div class="master-panel">
    <h1>ðŸŽ§ DJ MASTER ENGINE v7</h1>
    <p>Algoritm de Normalizare È™i CorecÈ›ie YouTube</p>

    <input type="file" id="audioFiles" multiple accept="audio/*">
    
    <div class="format-selector">
        <label>SELECTEAZÄ‚ FORMAT EXPORT: </label>
        <select id="exportFormat">
            <option value="wav">WAV (Lossless - Recomandat DJ)</option>
            <option value="mp3">MP3 (High Quality 320kbps Style)</option>
            <option value="flac">FLAC (ArhivÄƒ Lossless)</option>
        </select>
    </div>

    <div class="stats-grid">
        <div class="stat-item">NUME ORIGINAL: <span id="fileName">AÈ™teptare...</span></div>
        <div class="stat-item">MASTER GAIN: <span id="mGain">+4.2 dB</span></div>
        <div class="stat-item">BASS BOOST: <span id="bBoost">On (65Hz)</span></div>
        <div class="stat-item">LIMITER: <span id="lCap">-0.3 dBFS</span></div>
    </div>

    <canvas id="waveCanvas"></canvas>
    
    <div class="controls">
        <button id="processBtn" class="btn-master">MasterizeazÄƒ & Download</button>
    </div>
    
    <div id="status-log">FiÈ™ierele vor fi salvate automat cu numele original.</div>
</div>

<script>
    const fileInput = document.getElementById('audioFiles');
    const processBtn = document.getElementById('processBtn');
    const log = document.getElementById('status-log');
    const canvas = document.getElementById('waveCanvas');
    const ctx = canvas.getContext('2d');

    processBtn.onclick = async () => {
        const files = fileInput.files;
        if (files.length === 0) return alert("ÃŽncarcÄƒ melodiile!");

        for (let file of files) {
            document.getElementById('fileName').innerText = file.name;
            log.innerText = `Se proceseazÄƒ: ${file.name}`;
            await processAudio(file);
        }
        log.innerText = "Gata! Toate melodiile masterizate au fost descÄƒrcate.";
    };

    async function processAudio(file) {
        const arrayBuffer = await file.arrayBuffer();
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const decodedData = await audioCtx.decodeAudioData(arrayBuffer);

        const offlineCtx = new OfflineAudioContext(
            decodedData.numberOfChannels,
            decodedData.length,
            decodedData.sampleRate
        );

        const source = offlineCtx.createBufferSource();
        source.buffer = decodedData;

        // --- ALGORITM DE MASTERING ---
        const bass = offlineCtx.createBiquadFilter();
        bass.type = "lowshelf";
        bass.frequency.value = 65;
        bass.gain.value = 6;

        const treble = offlineCtx.createBiquadFilter();
        treble.type = "highshelf";
        treble.frequency.value = 10000;
        treble.gain.value = 5;

        const compressor = offlineCtx.createDynamicsCompressor();
        compressor.threshold.value = -20;
        compressor.ratio.value = 4;

        const limiter = offlineCtx.createDynamicsCompressor();
        limiter.threshold.value = -0.3;

        source.connect(bass);
        bass.connect(treble);
        treble.connect(compressor);
        compressor.connect(limiter);
        limiter.connect(offlineCtx.destination);

        source.start(0);
        const renderedBuffer = await offlineCtx.startRendering();
        
        drawWaveform(renderedBuffer);

        // SALVARE CU NUMELE ORIGINAL
        const selectedExt = document.getElementById('exportFormat').value;
        const newFileName = "MASTER_" + file.name.split('.').slice(0, -1).join('.') + "." + selectedExt;
        
        exportWav(renderedBuffer, newFileName);
    }

    function drawWaveform(buffer) {
        const data = buffer.getChannelData(0);
        const step = Math.ceil(data.length / canvas.width);
        const amp = canvas.height / 2;
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "#00ffcc";
        ctx.beginPath();
        for(let i=0; i < canvas.width; i++) {
            let min = 1.0, max = -1.0;
            for(let j=0; j<step; j++) {
                let datum = data[(i*step)+j];
                if (datum < min) min = datum;
                if (datum > max) max = datum;
            }
            ctx.lineTo(i, (1+min)*amp);
            ctx.lineTo(i, (1+max)*amp);
        }
        ctx.stroke();
    }

    function exportWav(buffer, filename) {
        const length = buffer.length * buffer.numberOfChannels * 2 + 44;
        const view = new DataView(new ArrayBuffer(length));
        const s = (o, str) => { for(let i=0; i<str.length; i++) view.setUint8(o+i, str.charCodeAt(i)); };
        
        s(0, 'RIFF'); view.setUint32(4, length-8, true); s(8, 'WAVE');
        s(12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
        view.setUint16(22, buffer.numberOfChannels, true); view.setUint32(24, buffer.sampleRate, true);
        view.setUint32(28, buffer.sampleRate * buffer.numberOfChannels * 2, true);
        view.setUint16(32, buffer.numberOfChannels * 2, true); view.setUint16(34, 16, true);
        s(36, 'data'); view.setUint32(40, length-44, true);

        let offset = 44;
        for (let i = 0; i < buffer.length; i++) {
            for (let ch = 0; ch < buffer.numberOfChannels; ch++) {
                let sample = Math.max(-1, Math.min(1, buffer.getChannelData(ch)[i]));
                view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                offset += 2;
            }
        }
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([view], {type:'audio/wav'}));
        link.download = filename;
        link.click();
    }
</script>
</body>
</html>
