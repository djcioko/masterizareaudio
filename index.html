async function processAudio() {
        if (selectedFiles.length === 0) return alert("Selectează melodii!");
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        for (let file of selectedFiles) {
            const arrayBuffer = await file.arrayBuffer();
            const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            applyDoctorMixLogic(audioBuffer);
        }
    }

    function applyDoctorMixLogic(buffer) {
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;

        // 1. ANALOG SATURATION (Simulăm lămpile de la Doctor Mix)
        const shaper = audioCtx.createWaveShaper();
        shaper.curve = makeDistortionCurve(15); // 15 e nivelul de "warmth"

        // 2. STEREO WIDENER (Lărgim sunetul)
        const splitter = audioCtx.createChannelSplitter(2);
        const merger = audioCtx.createChannelMerger(2);
        const delayL = audioCtx.createDelay();
        delayL.delayTime.value = 0.012; // Mică întârziere pe stânga pentru lărgire

        // 3. MASTER COMPRESSOR (Setări agresive de DJ)
        const compressor = audioCtx.createDynamicsCompressor();
        compressor.threshold.setValueAtTime(-18, audioCtx.currentTime);
        compressor.ratio.setValueAtTime(4, audioCtx.currentTime);
        compressor.attack.setValueAtTime(0.003, audioCtx.currentTime);

        // 4. FINAL LIMITER (Să nu sară de 0dB)
        const limiter = audioCtx.createDynamicsCompressor();
        limiter.threshold.setValueAtTime(-1.0, audioCtx.currentTime);
        limiter.ratio.setValueAtTime(20, audioCtx.currentTime);

        // CONECTARE (Lanțul de mastering)
        source.connect(shaper);
        shaper.connect(compressor);
        compressor.connect(limiter);
        limiter.connect(audioCtx.destination);

        source.start(0);
        document.getElementById('status').innerText = "Mastering Analog Style activat!";
    }

    // Funcția care creează "căldura" analogică
    function makeDistortionCurve(amount) {
        let k = typeof amount === 'number' ? amount : 50,
            n_samples = 44100,
            curve = new Float32Array(n_samples),
            deg = Math.PI / 180, i = 0, x;
        for ( ; i < n_samples; ++i ) {
            x = i * 2 / n_samples - 1;
            curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
        }
        return curve;
    }
